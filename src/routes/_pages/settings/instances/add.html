<SettingsLayout page='settings/instances/add' label={pageLabel}>
  <h1 id="add-an-instance-h1">{pageLabel}</h1>

  <div class="{singleInstance ? '' : 'add-new-instance'}">
    <form on:submit='onSubmitInstance(event)' aria-labelledby="add-an-instance-h1">

      {#if !hasIndexedDB || !hasLocalStorage}
        <div class="form-error form-error-user-error" role="alert">
          {'intl.storageError'}
        </div>
      {/if}

      {#if $logInToInstanceError && $logInToInstanceErrorForText === instance}
        <div class="form-error form-error-user-error" role="alert">
          {'intl.errorShort'} {@html $logInToInstanceError}
        </div>
      {/if}

      <noscript>
        <div class="form-error" role="alert">
          {'intl.javaScriptError'}
        </div>
      </noscript>

      {#if !singleInstance}
        <fieldset class="form-fieldset">
          <legend>{'intl.chooseProtocol' || 'Choose Protocol'}</legend>
          <div>
            <input type="radio" id="protocolActivityPub" name="protocol" value="activitypub" bind:group='protocolToAdd'>
            <label for="protocolActivityPub">ActivityPub (Mastodon, etc.)</label>
          </div>
          <div>
            <input type="radio" id="protocolAtproto" name="protocol" value="atproto" bind:group='protocolToAdd'>
            <label for="protocolAtproto">ATProto (Bluesky)</label>
          </div>
        </fieldset>

        {#if protocolToAdd === 'activitypub'}
          <label for="instanceInput">{'intl.instanceColon'}</label>
          <input type="text" inputmode="url" autocapitalize="none" spellcheck="false" id="instanceInput"
                bind:value='$instanceNameInSearch' placeholder="{'intl.enterInstanceName'}" required={protocolToAdd === 'activitypub'}>
        {:else if protocolToAdd === 'atproto'}
          <label for="atprotoHandleInput">{'intl.atprotoHandleLabel' || 'Bluesky Handle (e.g., name.bsky.social)'}</label>
          <input type="text" inputmode="url" autocapitalize="none" spellcheck="false" id="atprotoHandleInput"
                bind:value='atprotoHandle' placeholder="{'intl.atprotoHandlePlaceholder' || 'yourname.bsky.social'}" required={protocolToAdd === 'atproto'}>

          <label for="atprotoPasswordInput">{'intl.atprotoAppPasswordLabel' || 'App Password'}</label>
          <input type="password" id="atprotoPasswordInput" bind:value='atprotoPassword' placeholder="{'intl.atprotoAppPasswordPlaceholder' || 'xxxx-xxxx-xxxx-xxxx'}" required={protocolToAdd === 'atproto'}>

          <label for="atprotoPdsUrlInput">{'intl.atprotoPdsUrlLabel' || 'Bluesky Server (PDS URL - optional)'}</label>
          <input type="text" inputmode="url" autocapitalize="none" spellcheck="false" id="atprotoPdsUrlInput"
                bind:value='atprotoPdsUrl' placeholder="{'intl.atprotoPdsUrlPlaceholder' || 'https://bsky.social'}">
        {/if}
      {/if}
      <button class="primary" type="submit" id="submitButton"
              disabled={disableSubmitButton}>
        {'intl.logIn'}
      </button>
    </form>
  </div>

  {#if !singleInstance && !$isUserLoggedIn && protocolToAdd === 'activitypub'}
    <p>
      {'intl.getAnInstancePre'}
      <Tooltip
        text="{'intl.getAnInstanceText'}"
        tooltipText="{'intl.getAnInstanceDescription'}"
      />
      {'intl.getAnInstancePost'}
      <a rel="noopener" target="_blank" href="https://joinmastodon.org">{'intl.joinMastodon'}</a>
    </p>
  {/if}
</SettingsLayout>
<style>
  .add-new-instance {
    background: var(--form-bg);
    padding: 5px 10px 15px;
    margin: 20px auto;
    border: 1px solid var(--form-border);
    border-radius: 4px;
  }

  .form-error {
    border: 2px solid var(--warn-color);
    border-radius: 2px;
    padding: 10px;
    font-size: 1.3em;
    margin: 5px;
    background-color: var(--main-bg);
  }
  input {
    min-width: 70%;
    max-width: 100%;
    background-color: var(--input-bg);
  }

  label, input, button, :global(.add-new-instance-aside) {
    display: block;
    margin: 20px 5px;
  }

  @media (max-width: 767px) {
    input {
      min-width: 95%;
    }
  }

</style>
<script>
  import SettingsLayout from '../../../_components/settings/SettingsLayout.html'
  import { store } from '../../../_store/store.js'
  import { logInToInstance, handleOauthCode } from '../../../_actions/addInstance.js'
  import { testHasIndexedDB, testHasLocalStorage } from '../../../_utils/testStorage.js'
  import Tooltip from '../../../_components/Tooltip.html'

  export default {
    async oncreate () {
      const params = new URLSearchParams(location.search)
      const code = params.get('code')
      if (code) {
        await handleOauthCode(code)
      } else {
        this.set({
          hasIndexedDB: await testHasIndexedDB(),
          hasLocalStorage: testHasLocalStorage()
        })
      }
    },
    components: {
      SettingsLayout,
      Tooltip
    },
    store: () => store,
    data: () => ({
      hasIndexedDB: true,
      hasLocalStorage: true,
      singleInstance: process.env.SINGLE_INSTANCE,
      protocolToAdd: 'activitypub', // Default protocol
      atprotoHandle: '',
      atprotoPassword: '',
      atprotoPdsUrl: '',
      // Placeholder intl strings - these should be added to actual intl files
      'intl.chooseProtocol': 'Select Protocol',
      'intl.atprotoHandleLabel': 'Bluesky Handle (e.g., name.bsky.social)',
      'intl.atprotoHandlePlaceholder': 'yourname.bsky.social',
      'intl.atprotoAppPasswordLabel': 'App Password',
      'intl.atprotoAppPasswordPlaceholder': 'xxxx-xxxx-xxxx-xxxx',
      'intl.atprotoPdsUrlLabel': 'Bluesky Server (PDS URL - optional)',
      'intl.atprotoPdsUrlPlaceholder': 'https://bsky.social (default if blank)',
    }),
    computed: {
      pageLabel: ({ $isUserLoggedIn }) => $isUserLoggedIn ? 'intl.addInstance' : 'intl.logIn',
      // 'instance' computed property is used for disabling button; adapt for protocol
      instance: ({ $instanceNameInSearch, protocolToAdd, atprotoHandle, atprotoPassword }) => {
        if (process.env.SINGLE_INSTANCE) return process.env.SINGLE_INSTANCE;
        if (protocolToAdd === 'atproto') {
          return atprotoHandle && atprotoPassword; // Basic check for ATProto
        }
        return $instanceNameInSearch; // Existing check for AP
      },
      disableSubmitButton: ({ singleInstance, $isUserLoggedIn, instance, $logInToInstanceLoading, protocolToAdd, atprotoHandle, atprotoPassword, $instanceNameInSearch }) => {
        if (singleInstance && $isUserLoggedIn) return true;
        if ($logInToInstanceLoading) return true;
        if (protocolToAdd === 'activitypub') {
          return !($instanceNameInSearch && $instanceNameInSearch.trim());
        } else if (protocolToAdd === 'atproto') {
          return !(atprotoHandle && atprotoHandle.trim() && atprotoPassword && atprotoPassword.trim());
        }
        return true; // Should not happen if protocol is selected
      }
    },
    methods: {
      onSubmitInstance (event) {
        event.preventDefault()
        event.stopPropagation()

        const { protocolToAdd, atprotoHandle, atprotoPassword, atprotoPdsUrl } = this.get()
        const { instanceNameInSearch } = this.store.get() // for AP

        if (process.env.SINGLE_INSTANCE) {
          // Assuming single instance mode is ActivityPub only for now
          this.store.set({ instanceNameInSearch: process.env.SINGLE_INSTANCE, instanceTypeToAdd: 'activitypub' })
        } else {
          this.store.set({
            instanceTypeToAdd: protocolToAdd,
            // For AP, instanceNameInSearch is already bound from input
            // For ATProto, need to pass handle as identifier, and other details
            instanceNameInSearch: protocolToAdd === 'atproto' ? atprotoHandle : instanceNameInSearch,
            atprotoPassword: protocolToAdd === 'atproto' ? atprotoPassword : '', // Clear if not ATProto
            atprotoPdsUrl: protocolToAdd === 'atproto' ? (atprotoPdsUrl || 'https://bsky.social') : '' // Default PDS, clear if not ATProto
          })
        }
        logInToInstance()
      }
    }
  }
</script>
